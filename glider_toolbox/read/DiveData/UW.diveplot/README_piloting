Overview
--------

This is a collection of matlab scripts that can be used for basic
piloting of a Seaglider.  They rely upon the netcdf output of the
basestation code (pGGGDDDD.nc files) and the sg_calib_constants.m file
associated with the deployment.  The contents of the each dive's nc
file is described in the Seaglider_Quality_Control_Manual.html.  The
basestation also provides a kml file, displayable in Google Earth,
that contains the flight tracks of the glider during the deployment.

Installation
------------
Create and load this code into a directory:

$ mkdir <piloting_code_dir>
$ cd <piloting_code_dir>
$ tar xvf Piloting.tar.gz

Add the directory to your MATLAB path, e.g.,

>> path('<piloting_code_dir>', path); 

Make sure this directory is ahead of all others.

Displaying a dive's data
------------------------

To display basic flight and science data from dives you will need a
set of either nc per-dive files from the basestation for a deployment
and the associated sg_calib_constants.m file.  

>> cd <location containing dive files>
>> diveplot

In addition to asking for a dive number to display it will ask if you
want to see the 'operational' graphs, which include basic per-dive
regressions for pitch, roll and vbd; answer '1' for yes, '0' for
no. Diveplot always displays the basic flight and data diagrams.

To inspect the TS diagram in greater detail, after running diveplot,
run:

>> ts_diagram

This displays the TS diagram as before but you can select points to
understand where in the water column events are happening on dive and
climb.


Trimming a Seaglider
--------------------

Typically the first few dives are used to determine the pitch, roll,
and vbd centers and pitch and roll gains of the vehicle for optimal
flight performance.  Several scripts help this process.

First, try the trim script.  

 >> trim

Like diveplot, it asks for a dive (typically the most recent). It
attempts to recommend, in text, changes to certain trim parameters
(pitch center and gain, roll and vbd centers) based on this dive.
(This code duplicates some of the code in the diveplot routine above.)

After a few dives, and as the deployment progresses, you should run
pitch, roll, and vbd regressions based on collections of several
recent dives.  Using a collection of dives provides better statistics
for the vehicle. To ensure the vehicle is well-characterized you
should create dives that explore steep and shallow pitch angles (by
adjusting $D_TGT and $T_DIVE) and that vary the applied thrust (by
varying $MAX_BOUY).  This will produce the different horizontal and
vertical velocities required to characterize the critical buoyancy and
hydrodynamic flight model parameters for the vehicle and its payload.

There are three regression scripts for pitch, roll and vbd-related issues.

>> regress_pitch

This script asks for a collection of dives to use.  You can enter
dives as a combination space-separated single numbers and ranges of dive numbers
specified as start:end dive numbers, e.g.,

 4 6 8 20:25 35

This would regress over the data in these 10 dives.  Specifying a
collection of dives in this fashion allows you to skip problematic
dives.

The pitch graphs show the implied $PITCH_GAIN and $C_PITCH values. You
should use those to update the values aboard the glider.

>> regress_roll

Like regress_pitch, this script will ask for a collection of dives to
use. The roll graphs show the $ROLL_GAIN and dive and climb $C_ROLL
parameters. You should use those to update the values aboard the
glider.

To improve the flight model fit, which impacts estimates of
velocities, thermal-inertia in the CT system and depth-average current for the
vehicle, you should regress various VBD and hydrodynamic parameters.
To help select the dives that are likely to best characterize these
parameters run:

>> regress_vbd_dives

This will review all the existing dives and select a subset that
reflect the vehicle flying at extreme values of pitch and buoyancy.
It will also warn you if you don't have sufficient dives.  Then, to
regress the flight parameters themselves, run:

>> regress_vbd

Like regress_pitch and regress_roll, this script will ask for a
collection of dives to use.  You can enter the list generated by
regress_vbd_dives or another subset of your choosing.  The code first
determines volmax and vbd_bias.  Next, using the new volmax estimate,
it determines more optimal abc parameters (a - lift, b - drag, c -
implied drag) for the vehicle.  Note that if you have reasonable
spread of dives, the fit for a and b are generally quite good and
repeatable but c is very hard to fit and can vary quite a bit between
runs. Finally, it determines the thermal expansion and compression
coefficients of the Seaglider hull and fairing; like volmax and
vbdbias, these impact the buoyancy calculation used by the flight
model.

The final vbd_bias value should not be less than 1cc.  The RMS of w -
w_stdy should have decreased and be less than 2cm/s. Copy-and-paste
the changed values into your sg_calicb_constants.m file for subsequent
basestation processing. If you want to update and reprocess old dives
on the basis of these new parameters, run:

>> reprocess

Calibrating the compass at sea
------------------------------

See the separate (somewhat overlapping) code in
Compass_Calibration.tar.gz.  Review README_compass for an explanation
of compass calibration procedures, both on land and at sea.